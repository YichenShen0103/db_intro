# 限流配置 - 防止DDoS攻击
limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;
limit_req_zone $binary_remote_addr zone=general_limit:10m rate=30r/s;
limit_conn_zone $binary_remote_addr zone=conn_limit:10m;

# 隐藏nginx版本号
server_tokens off;

server {
    listen 80;
    server_name _;

    # 全局请求体大小限制
    client_max_body_size 50m;
    client_body_buffer_size 128k;

    # 超时配置
    client_header_timeout 30s;
    client_body_timeout 30s;
    send_timeout 30s;
    keepalive_timeout 65s;

    # 安全响应头
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;
    
    # CORS配置 - 开发环境，生产环境应该限制具体域名
    add_header Access-Control-Allow-Origin "*" always;
    add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Origin, Content-Type, Authorization, X-Requested-With" always;
    add_header Access-Control-Max-Age "3600" always;

    # 访问日志
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log warn;

    # 禁止访问隐藏文件
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }

    # Serve Static Files (Frontend)
    location / {
        # 限流 - 普通请求
        limit_req zone=general_limit burst=20 nodelay;
        limit_conn conn_limit 10;

        root /usr/share/nginx/html;
        index index.html index.htm;
        try_files $uri $uri/ /index.html;
    }

    # 文件上传接口 - 更大的请求体限制
    location ~ ^/api/projects$ {
        # 处理OPTIONS预检请求
        if ($request_method = 'OPTIONS') {
            add_header Access-Control-Allow-Origin "*" always;
            add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
            add_header Access-Control-Allow-Headers "Origin, Content-Type, Authorization, X-Requested-With" always;
            add_header Access-Control-Max-Age "3600" always;
            add_header Content-Type "text/plain; charset=utf-8";
            add_header Content-Length 0;
            return 204;
        }

        # 限流 - API请求
        limit_req zone=api_limit burst=5 nodelay;
        
        # 文件上传特殊限制
        client_max_body_size 100m;
        client_body_timeout 300s;
        
        proxy_pass http://backend:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 文件上传超时
        proxy_connect_timeout 300s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
        
        # 请求体缓冲
        proxy_request_buffering off;
    }

    # API proxy to backend service
    location /api/ {
        # 处理OPTIONS预检请求
        if ($request_method = 'OPTIONS') {
            add_header Access-Control-Allow-Origin "*" always;
            add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
            add_header Access-Control-Allow-Headers "Origin, Content-Type, Authorization, X-Requested-With" always;
            add_header Access-Control-Max-Age "3600" always;
            add_header Content-Type "text/plain; charset=utf-8";
            add_header Content-Length 0;
            return 204;
        }

        # 限流 - API请求
        limit_req zone=api_limit burst=5 nodelay;
        limit_conn conn_limit 5;
        
        proxy_pass http://backend:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 超时配置
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
        
        # 禁用不必要的方法
        limit_except GET POST PUT DELETE OPTIONS {
            deny all;
        }
    }

    # 静态文件访问 - 上传的文件
    location /uploads/ {
        # 限流
        limit_req zone=general_limit burst=10 nodelay;
        
        proxy_pass http://backend:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        
        # 静态文件缓存
        proxy_cache_valid 200 1h;
        add_header Cache-Control "public, max-age=3600";
        
        # 恢复被覆盖的头部
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;
        add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;
        add_header Access-Control-Allow-Origin "*" always;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Origin, Content-Type, Authorization, X-Requested-With" always;
        add_header Access-Control-Max-Age "3600" always;

        # 只允许GET和HEAD
        limit_except GET HEAD {
            deny all;
        }
    }

    # 健康检查端点 - 不限流
    location /api/ping {
        proxy_pass http://backend:8080;
        proxy_set_header Host $host;
        access_log off;
    }
}
